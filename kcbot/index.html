<!DOCTYPE html>
<html>

<head>
    <title>Robot</title>
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1.0,
                                   maximum-scale=1.0,
                                   user-scalable=no,
                                   minimal-ui">
    <link rel="stylesheet" href="//cdn.kik.com/app/2.0.1/app.min.css">
    <style>
    #form {
        position: fixed;
        bottom: 0;
        width: 100%;
        border-top: 1px double #eee;
    }
    #chat {
        margin-bottom: 50px;
    }
    input[disabled] {
        background-color: #eee;
    }
    #send, #tryagain {
        position: relative;
        margin-bottom: -45px;
        bottom: 45px;
    }
    #send {
        right: 0;
        width: 65px;
        margin-right: 0;
    }
    #tryagain {
        left: 0;
        width: 54px;
        margin-left: 0;
    }
    </style>
</head>

<body>

    <div class="app-page" data-page="main">
        <div class="app-topbar">
            <div class="app-title">Robot</div>
        </div>
        <div class="app-content">
            <div id="chat" class="app-section"></div>
            <div id="form">
                <div id="tryagain" class="app-button secondary">What?</div>
                <input placeholder="type here..." class="app-input">
                <div id="send" class="app-button green">Send</div>
            </div>
        </div>
    </div>

    <script src="//zeptojs.com/zepto.min.js"></script>
    <script src="//cdn.kik.com/app/2.0.1/app.min.js"></script>

    <script>
    var server = new WebSocket("ws://kcbot.herokuapp.com");

    server.onmessage = function(m) {
        if (m.data !== "ping") {
            bot(m.data);
            $("input")
                .prop("disabled", false)
                .attr("placeholder", "type here...");
        }
    };

    server.onerror = function(e) {
        console.log("Error!");
    }

    server.onopen = function() {
        try {
            App.restore();
        } catch (err) {
            App.load("main");
        }
    }

    function bot(text) {
        $("#chat").append(text ? "<p><b>" + text + "</b></p>" : "");
    }

    function me(text) {
        $("#chat").append(text ? "<p>" + text + "</p>" : "");
    }

    App.controller("main", function(page) {
        $(page)
            .find("#chat")
            .html("<b>Ask me questions!  Click <kbd>What?</kbd> if what I say doesn't make sense. :]</b><hr />");

        $(page)
            .find("#send")
            .click(function() {
                $("input")
                    .prop("disabled", true)
                    .attr("placeholder", "waiting for bot...");

                var text = $("input").val();
                if (text !== "") {
                    server.send(text);
                    me(text);
                    $("input").val("");
                }
            });

        $(page)
            .find("#tryagain")
            .click(function(){
                $("input").val("");
                $("input")
                    .prop("disabled", true)
                    .attr("placeholder", "waiting for bot...");
                server.send('sysWhatTryAgainIDontUnderstand');
            });

        $(page)
            .find("input")
            .css({
                "display": "inline",
                "position": "relative",
                "left": "54px",
                "width": "calc(100% - 65px - 54px)"
            })
            .click(function() {
                setTimeout(function() {
                    $("input").focus();
                }, 1000);
            });
    });
    </script>

</body>

</html>
